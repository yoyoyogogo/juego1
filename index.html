<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Auto 3D Game - Con Bass Boost Vibration</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: sans-serif; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 4px; background: white; border-radius: 50%; pointer-events: none; display: none; }
        
        #musicMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00ff88;
            color: white;
            display: none;
            min-width: 400px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }
        
        #musicMenu h2 {
            margin-top: 0;
            color: #00ff88;
            text-align: center;
        }
        
        #musicMenu input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #00ff88;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        #musicMenu button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #playBtn {
            background: #00ff88;
            color: black;
            font-weight: bold;
        }
        
        #playBtn:hover {
            background: #00cc6a;
            transform: scale(1.05);
        }
        
        #stopBtn {
            background: #ff4444;
            color: white;
        }
        
        #stopBtn:hover {
            background: #cc0000;
        }
        
        #closeBtn {
            background: #666;
            color: white;
        }
        
        #closeBtn:hover {
            background: #888;
        }
        
        .musicStatus {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 5px;
            text-align: center;
        }
        
        .volumeControl {
            margin: 15px 0;
        }
        
        .volumeControl label {
            display: block;
            margin-bottom: 5px;
            color: #00ff88;
        }
        
        .volumeControl input[type="range"] {
            width: 100%;
        }
        #audioPlayer {
            display: none;
        }
    </style>
</head>
<body>
    <div id="ui">
        <b>Modo:</b> <span id="mode">Jugador</span><br>
        <b>Controles Jugador:</b> WASD + Mouse<br>
        <b>Controles Auto:</b> Flechas o WASD<br>
        <b>Entrar/Salir Auto:</b> E o Enter<br>
        <b>M√∫sica del Auto:</b> F<br>
        <span id="status">Cargando modelo...</span><br>
        <span id="musicInfo" style="color: #00ff88;"></span>
    </div>
    <div id="crosshair"></div>
    
    <div id="musicMenu">
        <h2>üéµ Music Car - Radio üéµ</h2>
        <input type="text" id="musicUrl" placeholder="Pega aqu√≠ el link .mp3 de tu m√∫sica (ideal bass boosted)">
        <div class="volumeControl">
            <label>Volumen M√°ximo: <span id="volumeValue">100</span>%</label>
            <input type="range" id="volumeSlider" min="0" max="100" value="100">
        </div>
        <div style="text-align: center;">
            <button id="playBtn">‚ñ∂Ô∏è Reproducir</button>
            <button id="stopBtn">‚èπÔ∏è Detener</button>
            <button id="closeBtn">‚úñÔ∏è Cerrar</button>
        </div>
        <div class="musicStatus">
            <span id="musicStatusText">No hay m√∫sica cargada</span>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #888;">
            üí° Tip: La m√∫sica se escucha m√°s fuerte cerca del auto<br>
            üî• ¬°Con bass boosted el auto brinca y vibra!
        </div>
    </div>
    <audio id="audioPlayer" loop crossorigin="anonymous"></audio>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // Sistema de Audio + Analizador de Bass
        let audioPlayer = document.getElementById('audioPlayer');
        let audioContext = null;
        let analyser = null;
        let source = null;
        let bassEnergy = 0;
        let maxVolume = 1.0;
        let isPlaying = false;

        // Variables para el efecto de brinco/vibraci√≥n
        let baseCarY = 1.5;
        let bounceTarget = 0;
        let bounceVelocity = 0;
        let vibration = 0;

        // 1. ESCENA Y RENDERER
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        scene.fog = new THREE.Fog(0x87ceeb, 150, 400);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // 2. C√ÅMARA
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        // 3. CONTROLES DE POINTER LOCK
        const controls = new PointerLockControls(camera, document.body);
        scene.add(controls.getObject());
        
        let isPlayerMode = true;
        const playerSpeed = 0.15;
        const playerRadius = 0.5;
        const moveForward = { active: false };
        const moveBackward = { active: false };
        const moveLeft = { active: false };
        const moveRight = { active: false };

        document.addEventListener('click', () => {
            if (isPlayerMode && !controls.isLocked) {
                controls.lock();
            }
        });

        controls.addEventListener('lock', () => {
            document.getElementById('crosshair').style.display = 'block';
        });
        controls.addEventListener('unlock', () => {
            document.getElementById('crosshair').style.display = 'none';
        });

        // 4. LUCES, PISO, CARRETERA, √ÅRBOLES, etc. (igual que antes)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(50, 50, 50);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 2048;
        sun.shadow.mapSize.height = 2048;
        scene.add(sun);

        const floorGeo = new THREE.PlaneGeometry(1000, 1000);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x5cb85c, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        const roadGeo = new THREE.PlaneGeometry(20, 1000);
        const roadMat = new THREE.MeshStandardMaterial({ color: 0x3d3d3d, roughness: 0.9 });
        const road = new THREE.Mesh(roadGeo, roadMat);
        road.rotation.x = -Math.PI / 2;
        road.position.y = 0.01;
        road.receiveShadow = true;
        scene.add(road);

        // L√≠neas amarillas
        const lineGeo = new THREE.PlaneGeometry(0.5, 10);
        const lineMat = new THREE.MeshBasicMaterial({ color: 0xffdd00 });
        for (let i = -50; i < 50; i++) {
            const line = new THREE.Mesh(lineGeo, lineMat);
            line.rotation.x = -Math.PI / 2;
            line.position.set(0, 0.02, i * 20);
            scene.add(line);
        }

        // √Årboles, nubes y flores (mismo c√≥digo que ten√≠as)
        function createTree(x, z) {
            const tree = new THREE.Group();
            const trunkGeo = new THREE.CylinderGeometry(0.3, 0.4, 3, 8);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x6b4423, roughness: 0.9 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.y = 1.5;
            trunk.castShadow = true;
            tree.add(trunk);

            const foliageGeo = new THREE.SphereGeometry(2, 8, 8);
            const foliageMat = new THREE.MeshStandardMaterial({ color: 0x3a7d3a, roughness: 0.8 });
            const foliage = new THREE.Mesh(foliageGeo, foliageMat);
            foliage.position.y = 4;
            foliage.castShadow = true;
            tree.add(foliage);

            tree.position.set(x, 0, z);
            return tree;
        }
        for (let i = 0; i < 30; i++) {
            const z = (Math.random() - 0.5) * 500;
            scene.add(createTree(-30 - Math.random() * 20, z));
            scene.add(createTree(30 + Math.random() * 20, z));
        }

        // (nubes y flores omitidas por brevedad, pero d√©jalas igual)

        // 6. CARGA DEL AUTO
        let car = null;
        let carContainer = new THREE.Group();
        let carCollisionBox = null;
        scene.add(carContainer);
        
        const loader = new GLTFLoader();
        const modelURL = 'https://raw.githubusercontent.com/yoyoyogogo/juego/main/music%20car%203d%20model%20(2).glb';
        loader.load(modelURL, (gltf) => {
            car = gltf.scene;
            
            const box = new THREE.Box3().setFromObject(car);
            const size = box.getSize(new THREE.Vector3()).length();
            const center = box.getCenter(new THREE.Vector3());
            
            car.position.x = -center.x;
            car.position.z = -center.z;
            car.position.y = -box.min.y;
            
            car.rotation.y = -Math.PI / 2;
            
            const scaleFactor = 8 / size; 
            car.scale.set(scaleFactor, scaleFactor, scaleFactor);
            
            car.traverse(n => { 
                if (n.isMesh) {
                    n.castShadow = true;
                    n.receiveShadow = true;
                }
            });
            
            carContainer.add(car);
            carContainer.position.set(0, baseCarY, -10); // baseCarY para controlar brinco
            
            const carBox = new THREE.Box3().setFromObject(carContainer);
            const carSize = carBox.getSize(new THREE.Vector3());
            carCollisionBox = {
                width: carSize.x * 0.8,
                length: carSize.z * 0.8,
                height: carSize.y
            };
            
            document.getElementById('status').innerText = "¬°Modelo cargado! Presiona F para la m√∫sica";
        });

        // === SISTEMA DE M√öSICA Y AN√ÅLISIS DE BASS ===
        const musicMenu = document.getElementById('musicMenu');
        const musicUrl = document.getElementById('musicUrl');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const closeBtn = document.getElementById('closeBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const musicStatusText = document.getElementById('musicStatusText');
        const musicInfo = document.getElementById('musicInfo');

        volumeSlider.addEventListener('input', (e) => {
            maxVolume = e.target.value / 100;
            volumeValue.textContent = e.target.value;
            if (audioPlayer) audioPlayer.volume = maxVolume;
        });

        playBtn.addEventListener('click', () => {
            const url = musicUrl.value.trim();
            if (!url) {
                alert('Por favor ingresa un link de m√∫sica');
                return;
            }
            
            // Crear AudioContext la primera vez
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.8;
            }

            audioPlayer.src = url;
            audioPlayer.volume = maxVolume;

            audioPlayer.play().then(() => {
                isPlaying = true;
                musicStatusText.textContent = 'üéµ Reproduciendo con bass boost';
                musicInfo.textContent = 'üéµ M√∫sica activa + Bass Vibration';

                // Conectar audio al analyser
                if (!source) {
                    source = audioContext.createMediaElementSource(audioPlayer);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                }
            }).catch((error) => {
                console.error('Error:', error);
                musicStatusText.textContent = '‚ùå Error al cargar m√∫sica';
                alert('No se pudo cargar. Prueba otro link directo .mp3');
            });
        });

        stopBtn.addEventListener('click', () => {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            isPlaying = false;
            musicStatusText.textContent = '‚è∏Ô∏è M√∫sica detenida';
            musicInfo.textContent = '';
            bounceTarget = 0;
            vibration = 0;
        });

        closeBtn.addEventListener('click', () => {
            musicMenu.style.display = 'none';
        });

        // Funci√≥n para detectar bajos fuertes
        function analyzeBass() {
            if (!analyser || !isPlaying) {
                bassEnergy = 0;
                return;
            }

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            let lowFreqEnergy = 0;
            const lowFreqEnd = Math.floor(150 / (audioContext.sampleRate / analyser.fftSize)); // ~150Hz
            for (let i = 0; i < lowFreqEnd; i++) {
                lowFreqEnergy += dataArray[i];
            }
            lowFreqEnergy /= lowFreqEnd;

            bassEnergy = lowFreqEnergy / 255; // Normalizado 0-1

            // Si hay un golpe fuerte de bajo
            if (bassEnergy > 0.7) {
                bounceTarget = 0.8; // Brinco fuerte
                vibration = 0.3;
            } else if (bassEnergy > 0.5) {
                bounceTarget = 0.4;
                vibration = 0.15;
            }
        }

        // Actualizar volumen por distancia
        function updateAudioVolume() {
            if (isPlaying && isPlayerMode && carContainer) {
                const playerPos = controls.getObject().position;
                const distance = playerPos.distanceTo(carContainer.position);
                const maxDistance = 50;
                const minDistance = 5;
                
                let volume = maxVolume;
                if (distance > minDistance) {
                    volume = maxVolume * Math.max(0, 1 - (distance - minDistance) / (maxDistance - minDistance));
                }
                audioPlayer.volume = volume;
            } else if (!isPlayerMode) {
                audioPlayer.volume = maxVolume;
            }
        }

        // Colisi√≥n (igual que antes)
        function checkCarCollision(newPosition) {
            if (!carCollisionBox || !isPlayerMode) return false;
            const carPos = carContainer.position;
            const carRot = carContainer.rotation.y;
            const dx = newPosition.x - carPos.x;
            const dz = newPosition.z - carPos.z;
            const localX = dx * Math.cos(-carRot) - dz * Math.sin(-carRot);
            const localZ = dx * Math.sin(-carRot) + dz * Math.cos(-carRot);
            const halfWidth = carCollisionBox.width / 2;
            const halfLength = carCollisionBox.length / 2;
            return Math.abs(localX) < halfWidth + playerRadius && Math.abs(localZ) < halfLength + playerRadius;
        }

        // Controles teclado (igual que antes)
        let carSpeed = 0;
        let carRotation = 0;

        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (key === 'w' || e.key === 'ArrowUp') moveForward.active = true;
            if (key === 's' || e.key === 'ArrowDown') moveBackward.active = true;
            if (key === 'a' || e.key === 'ArrowLeft') moveLeft.active = true;
            if (key === 'd' || e.key === 'ArrowRight') moveRight.active = true;

            if (key === 'f') {
                musicMenu.style.display = musicMenu.style.display === 'block' ? 'none' : 'block';
                if (musicMenu.style.display === 'block') controls.unlock();
            }

            if ((key === 'e' || e.key === 'Enter') && car) {
                const distance = controls.getObject().position.distanceTo(carContainer.position);
                if (isPlayerMode && distance < 5) {
                    isPlayerMode = false;
                    controls.unlock();
                    carSpeed = 0;
                    document.getElementById('mode').innerText = 'Auto';
                } else if (!isPlayerMode) {
                    isPlayerMode = true;
                    controls.getObject().position.set(carContainer.position.x + 3, 1.7, carContainer.position.z + 3);
                    scene.add(controls.getObject());
                    document.getElementById('mode').innerText = 'Jugador';
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (key === 'w' || e.key === 'ArrowUp') moveForward.active = false;
            if (key === 's' || e.key === 'ArrowDown') moveBackward.active = false;
            if (key === 'a' || e.key === 'ArrowLeft') moveLeft.active = false;
            if (key === 'd' || e.key === 'ArrowRight') moveRight.active = false;
        });

        // LOOP PRINCIPAL
        function update() {
            requestAnimationFrame(update);

            // Analizar bass
            analyzeBass();

            // Aplicar efecto de brinco y vibraci√≥n al auto
            if (carContainer) {
                // Brinco suave
                bounceVelocity += (bounceTarget - bounceVelocity) * 0.2;
                bounceVelocity *= 0.9;
                bounceTarget *= 0.9;

                // Vibraci√≥n lateral
                vibration *= 0.85;
                const vibOffset = Math.sin(Date.now() * 0.05) * vibration;

                carContainer.position.y = baseCarY + bounceVelocity + Math.abs(vibOffset) * 0.3;
                carContainer.position.x += vibOffset * 0.1;
            }

            if (isPlayerMode) {
                // Movimiento jugador (igual)
                const direction = new THREE.Vector3();
                direction.z = Number(moveForward.active) - Number(moveBackward.active);
                direction.x = Number(moveRight.active) - Number(moveLeft.active);
                direction.normalize();

                const velocity = new THREE.Vector3();
                if (moveForward.active || moveBackward.active) velocity.z = direction.z * playerSpeed;
                if (moveLeft.active || moveRight.active) velocity.x = direction.x * playerSpeed;

                const currentPos = controls.getObject().position.clone();
                controls.moveRight(velocity.x);
                controls.moveForward(velocity.z);

                if (checkCarCollision(controls.getObject().position)) {
                    controls.getObject().position.copy(currentPos);
                }

                controls.getObject().position.y = 1.7;
            } else {
                // Conducci√≥n auto
                if (moveForward.active) carSpeed += 0.01;
                if (moveBackward.active) carSpeed -= 0.01;
                if (moveLeft.active) carRotation += 0.03;
                if (moveRight.active) carRotation -= 0.03;
                carSpeed *= 0.95;

                carContainer.rotation.y = carRotation;
                carContainer.position.x += Math.sin(carRotation) * carSpeed;
                carContainer.position.z += Math.cos(carRotation) * carSpeed;

                const camOffset = new THREE.Vector3(
                    carContainer.position.x - Math.sin(carRotation) * 12,
                    carContainer.position.y + 5,
                    carContainer.position.z - Math.cos(carRotation) * 12
                );
                camera.position.lerp(camOffset, 0.1);
                camera.lookAt(carContainer.position);
            }

            updateAudioVolume();
            renderer.render(scene, camera);
        }
        update();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
